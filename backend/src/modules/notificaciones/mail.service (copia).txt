import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { MailtrapClient } from 'mailtrap';
import { Notificacion } from './entities/notificacion.entity';

export interface EmailOptions {
  to: string | string[];
  subject: string;
  html: string;
  cc?: string | string[];
  bcc?: string | string[];
  category?: string;
}

@Injectable()
export class MailService {
  private readonly logger = new Logger(MailService.name);
  private client: MailtrapClient | null = null;
  private mailEnabled: boolean;
  private sender: {
    email: string;
    name: string;
  };

  constructor(private configService: ConfigService) {
    this.mailEnabled = this.configService.get('mail.enabled') === 'true';
    this.sender = {
      email: this.configService.get('mail.fromEmail') || 'hello@demomailtrap.co',
      name: this.configService.get('mail.fromName') || 'Sistema de Onboarding',
    };

    if (this.mailEnabled) {
      this.initializeClient();
    } else {
      this.logger.warn('Mail service est√° deshabilitado. Las notificaciones se registrar√°n pero no se enviar√°n por correo.');
    }
  }

  private initializeClient() {
    try {
      const token = this.configService.get('mail.token');

      if (!token || token === '<YOUR_API_TOKEN>') {
        this.logger.warn('Token de Mailtrap no configurado o es el valor por defecto. Mail service deshabilitado.');
        this.mailEnabled = false;
        return;
      }

      this.client = new MailtrapClient({
        token: token,
      });

      this.logger.log('Cliente Mailtrap inicializado exitosamente');
      this.mailEnabled = true;
    } catch (error) {
      this.logger.error('Error al inicializar cliente Mailtrap:', error);
      this.mailEnabled = false;
    }
  }

  async sendEmail(options: EmailOptions): Promise<boolean> {
    if (!this.mailEnabled || !this.client) {
      this.logger.log(`[SIMULADO] Correo NO enviado - Destinatario: ${options.to}, Asunto: ${options.subject}`);
      this.logger.log(`[SIMULADO] Contenido: ${options.html.substring(0, 100)}...`);
      return true; // Devuelve true para simular √©xito
    }

    try {
      // Convertir destinatarios a formato Mailtrap
      const recipients = Array.isArray(options.to)
        ? options.to.map(email => ({ email }))
        : [{ email: options.to }];

      // Convertir CC si existe
      const cc = options.cc
        ? (Array.isArray(options.cc)
          ? options.cc.map(email => ({ email }))
          : [{ email: options.cc }])
        : undefined;

      // Convertir BCC si existe
      const bcc = options.bcc
        ? (Array.isArray(options.bcc)
          ? options.bcc.map(email => ({ email }))
          : [{ email: options.bcc }])
        : undefined;

      const response = await this.client.send({
        from: this.sender,
        to: recipients,
        cc,
        bcc,
        subject: options.subject,
        text: this.extractTextFromHtml(options.html),
        html: options.html,
        category: options.category || 'onboarding',
      });

      this.logger.log(`Correo enviado exitosamente. ID: ${response.message_ids?.join(', ')}`);
      return true;
    } catch (error) {
      this.logger.error('Error al enviar correo con Mailtrap:', error);

      // Si hay error, intentamos con modo simulado
      if (error.response?.data) {
        this.logger.error('Detalles del error:', error.response.data);
      }

      return false;
    }
  }

  private extractTextFromHtml(html: string): string {
    // Extraer texto simple del HTML para la versi√≥n de texto plano
    return html
      .replace(/<[^>]*>/g, ' ') // Remover tags HTML
      .replace(/\s+/g, ' ')     // Normalizar espacios
      .trim();
  }

  async sendNotificationEmail(notificacion: Notificacion): Promise<boolean> {
    if (!notificacion.destinatario?.email) {
      this.logger.error('No se puede enviar notificaci√≥n: destinatario sin email');
      return false;
    }

    this.logger.log(`Enviando notificaci√≥n a: ${notificacion.destinatario.email}, Tipo: ${notificacion.tipo}`);

    let category = 'onboarding';
    switch (notificacion.tipo) {
      case 'onboarding_agendado':
        category = 'onboarding_scheduled';
        break;
      case 'recordatorio_sesion':
        category = 'reminder';
        break;
      case 'cambio_estado':
        category = 'status_change';
        break;
      case 'nuevo_colaborador':
        category = 'new_employee';
        break;
      case 'sistema':
        category = 'system';
        break;
    }

    return await this.sendEmail({
      to: notificacion.destinatario.email,
      subject: notificacion.asunto,
      html: notificacion.contenido,
      category,
    });
  }

  async sendBulkNotification(
    notificaciones: Notificacion[],
  ): Promise<{ success: number; failed: number }> {
    const results = await Promise.allSettled(
      notificaciones.map(notif => this.sendNotificationEmail(notif))
    );

    const success = results.filter(r => r.status === 'fulfilled' && r.value).length;
    const failed = results.length - success;

    this.logger.log(`Notificaciones por lotes: ${success} exitosas, ${failed} fallidas`);

    return { success, failed };
  }

  async sendTestEmail(to: string): Promise<boolean> {
    const testHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: #00448D; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
          .content { background: #f9f9f9; padding: 20px; border: 1px solid #ddd; border-top: none; }
          .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>‚úÖ Correo de Prueba</h1>
            <p>Sistema de Gesti√≥n de Onboarding</p>
          </div>
          <div class="content">
            <h2>¬°Hola!</h2>
            <p>Este es un correo de prueba enviado desde el sistema de gesti√≥n de onboarding.</p>
            <p><strong>Fecha y hora:</strong> ${new Date().toLocaleString('es-ES')}</p>
            <p><strong>Sistema:</strong> Backend NestJS con Mailtrap</p>
            <p>Si recibes este correo, significa que la configuraci√≥n de notificaciones por correo est√° funcionando correctamente.</p>
            <p style="margin-top: 30px; padding: 15px; background: #e8f4fd; border-radius: 5px;">
              <strong>üìß Informaci√≥n t√©cnica:</strong><br>
              ‚Ä¢ Servicio: Mailtrap API<br>
              ‚Ä¢ M√©todo: Nodemailer + Mailtrap Transport<br>
              ‚Ä¢ Estado: ‚úÖ Configuraci√≥n exitosa
            </p>
          </div>
          <div class="footer">
            <p>Este es un mensaje autom√°tico. No respondas a este correo.</p>
            <p>¬© ${new Date().getFullYear()} Sistema de Gesti√≥n de Onboarding</p>
          </div>
        </div>
      </body>
      </html>
    `;

    const success = await this.sendEmail({
      to,
      subject: '‚úÖ Correo de prueba - Sistema de Onboarding',
      html: testHtml,
      category: 'test',
    });

    if (success) {
      this.logger.log(`Correo de prueba enviado exitosamente a: ${to}`);
    } else {
      this.logger.error(`Error al enviar correo de prueba a: ${to}`);
    }

    return success;
  }

  generateOnboardingTemplate(data: {
    colaboradorNombre: string;
    sesionTitulo: string;
    fechaInicio: string;
    fechaFin: string;
    ubicacion?: string;
    enlaceVirtual?: string;
    notas?: string;
    instructor?: string;
  }): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sesi√≥n de Onboarding</title>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
          }
          
          .email-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          }
          
          .header {
            background: linear-gradient(135deg, #00448D 0%, #0066CC 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
          }
          
          .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
          }
          
          .header p {
            opacity: 0.9;
            font-size: 14px;
          }
          
          .content {
            padding: 30px;
          }
          
          .greeting {
            font-size: 18px;
            margin-bottom: 25px;
            color: #00448D;
            font-weight: 600;
          }
          
          .info-card {
            background: #f8f9fa;
            border-left: 4px solid #00448D;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
          }
          
          .info-card h3 {
            color: #00448D;
            margin-bottom: 15px;
            font-size: 18px;
          }
          
          .info-item {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
          }
          
          .info-item .icon {
            margin-right: 10px;
            color: #00448D;
            min-width: 20px;
          }
          
          .info-item .text {
            flex: 1;
          }
          
          .info-item strong {
            color: #333;
            display: inline-block;
            min-width: 120px;
          }
          
          .button {
            display: inline-block;
            padding: 14px 28px;
            background: #00448D;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            margin-top: 10px;
          }
          
          .button:hover {
            background: #003366;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 68, 141, 0.3);
          }
          
          .notes {
            background: #fff8e1;
            border-left: 4px solid #FFD100;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
          }
          
          .notes h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
          }
          
          .footer {
            background: #f1f1f1;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #ddd;
          }
          
          .footer p {
            margin-bottom: 5px;
          }
          
          .highlight {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #b6d4fe;
          }
          
          @media (max-width: 600px) {
            .content {
              padding: 20px;
            }
            
            .header {
              padding: 20px 15px;
            }
            
            .info-item {
              flex-direction: column;
            }
            
            .info-item .icon {
              margin-bottom: 5px;
            }
          }
        </style>
      </head>
      <body>
        <div class="email-container">
          <div class="header">
            <h1>üéØ Sesi√≥n de Onboarding Programada</h1>
            <p>Sistema de Gesti√≥n de Onboarding T√©cnico</p>
          </div>
          
          <div class="content">
            <div class="greeting">Hola ${data.colaboradorNombre},</div>
            
            <p>Te informamos que has sido agendado para una sesi√≥n de onboarding t√©cnico. A continuaci√≥n encontrar√°s todos los detalles:</p>
            
            <div class="info-card">
              <h3>${data.sesionTitulo}</h3>
              
              <div class="info-item">
                <div class="icon">üìÖ</div>
                <div class="text">
                  <strong>Fechas:</strong> ${data.fechaInicio} - ${data.fechaFin}
                </div>
              </div>
              
              ${data.ubicacion ? `
              <div class="info-item">
                <div class="icon">üìç</div>
                <div class="text">
                  <strong>Ubicaci√≥n:</strong> ${data.ubicacion}
                </div>
              </div>
              ` : ''}
              
              ${data.enlaceVirtual ? `
              <div class="info-item">
                <div class="icon">üîó</div>
                <div class="text">
                  <strong>Enlace virtual:</strong> ${data.enlaceVirtual}
                </div>
              </div>
              ` : ''}
              
              ${data.instructor ? `
              <div class="info-item">
                <div class="icon">üë®‚Äçüè´</div>
                <div class="text">
                  <strong>Instructor:</strong> ${data.instructor}
                </div>
              </div>
              ` : ''}
            </div>
            
            ${data.enlaceVirtual ? `
            <div style="text-align: center; margin: 25px 0;">
              <a href="${data.enlaceVirtual}" class="button" style="color: white;">
                üöÄ Acceder a la Sesi√≥n
              </a>
              <p style="font-size: 12px; color: #666; margin-top: 5px;">
                El enlace estar√° activo 15 minutos antes del inicio
              </p>
            </div>
            ` : ''}
            
            ${data.notas ? `
            <div class="notes">
              <h4>üìù Informaci√≥n Adicional</h4>
              <p>${data.notas}</p>
            </div>
            ` : ''}
            
            <div class="highlight">
              <p><strong>üí° Preparaci√≥n recomendada:</strong></p>
              <ul style="margin: 10px 0 10px 20px;">
                <li>Laptop con bater√≠a cargada</li>
                <li>Conexi√≥n estable a internet</li>
                <li>Cuaderno o dispositivo para tomar notas</li>
                <li>Software necesario instalado previamente</li>
              </ul>
            </div>
            
            <p style="margin-top: 25px;">Si tienes alguna duda o impedimento para asistir, por favor comun√≠cate con el administrador del sistema.</p>
            
            <p style="margin-top: 20px; color: #00448D; font-weight: 600;">
              ¬°Te esperamos!
            </p>
          </div>
          
          <div class="footer">
            <p>Este es un mensaje autom√°tico generado por el Sistema de Gesti√≥n de Onboarding.</p>
            <p>Por favor, no respondas a este correo.</p>
            <p>¬© ${new Date().getFullYear()} Sistema de Gesti√≥n de Onboarding. Todos los derechos reservados.</p>
          </div>
        </div>
      </body>
      </html>
    `;
  }

  generateReminderTemplate(data: {
    colaboradorNombre: string;
    sesionTitulo: string;
    fechaInicio: string;
    horaInicio: string;
    tiempoRestante: string;
    enlaceVirtual?: string;
    ubicacion?: string;
  }): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Recordatorio de Sesi√≥n</title>
        <style>
          /* Estilos similares al template anterior pero con tema de recordatorio */
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fdf6e3 0%, #f5f5f5 100%);
            padding: 20px;
          }
          
          .email-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #FFD100;
          }
          
          .header {
            background: linear-gradient(135deg, #FFD100 0%, #FFE44D 100%);
            color: #333;
            padding: 25px 20px;
            text-align: center;
          }
          
          .header h1 {
            font-size: 22px;
            margin-bottom: 10px;
            font-weight: 700;
          }
          
          .reminder-badge {
            display: inline-block;
            background: #E31937;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
          }
          
          .content {
            padding: 30px;
          }
          
          .urgent-message {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
          }
          
          .urgent-message h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 18px;
          }
          
          .countdown {
            font-size: 24px;
            font-weight: 700;
            color: #E31937;
            margin: 15px 0;
          }
          
          .button {
            display: inline-block;
            padding: 14px 28px;
            background: linear-gradient(135deg, #E31937 0%, #FF4757 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            margin-top: 15px;
          }
          
          /* ... resto de estilos similares al template anterior ... */
        </style>
      </head>
      <body>
        <div class="email-container">
          <div class="header">
            <h1>‚è∞ Recordatorio de Sesi√≥n</h1>
            <p>Tu sesi√≥n de onboarding est√° por comenzar</p>
            <div class="reminder-badge">RECORDATORIO</div>
          </div>
          
          <div class="content">
            <div class="urgent-message">
              <h3>${data.sesionTitulo}</h3>
              <p>Tu sesi√≥n est√° programada para:</p>
              <div class="countdown">${data.fechaInicio} a las ${data.horaInicio}</div>
              <p><strong>Tiempo restante:</strong> ${data.tiempoRestante}</p>
            </div>
            
            <div style="margin: 25px 0; text-align: center;">
              ${data.enlaceVirtual ? `
              <a href="${data.enlaceVirtual}" class="button" style="color: white;">
                üö™ Unirse Ahora
              </a>
              ` : data.ubicacion ? `
              <p><strong>üìç Ubicaci√≥n:</strong> ${data.ubicacion}</p>
              ` : ''}
            </div>
            
            <p style="text-align: center; color: #666; font-size: 14px;">
              Por favor, aseg√∫rate de estar listo con tiempo suficiente.
            </p>
          </div>
        </div>
      </body>
      </html>
    `;
  }
}